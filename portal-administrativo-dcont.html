<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCont - Portal de Administra√ß√£o</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 
    ==============================================
    üî• CONFIGURA√á√ÉO FIREBASE + FIRESTORE
    ==============================================
    1. Ative o Firestore no Firebase Console
    2. Configure as regras (veja GUIA-FIRESTORE-SETUP.md)
    3. Cole suas credenciais abaixo
    ==============================================
    -->
    
    <style>
        /* [CSS IGUAL AO ANTERIOR - OMITIDO POR BREVIDADE] */
        /* Copie o CSS completo do portal-dcont-corrigido.html */
    </style>
</head>
<body>
    <!-- [HTML IGUAL - SIDEBAR E NAVEGA√á√ÉO] -->
    
    <!-- Firebase SDK -->
    <script type="module">
        // Imports do Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, updateDoc, doc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // SUAS CREDENCIAIS FIREBASE
        const firebaseConfig = {
  			apiKey: "AIzaSyDtRTKhlogKi9DGp_7kRWDVkeLFzAWMHek",
  			authDomain: "dcont-portal.firebaseapp.com",
  			projectId: "dcont-portal",
  			storageBucket: "dcont-portal.firebasestorage.app",
  			messagingSenderId: "440147165990",
  			appId: "1:440147165990:web:32370de307654bb61db7e7",
  			measurementId: "G-9SEK71JHJ7"
		};
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Estado global
        let currentUser = null;
        
        // Verificar autentica√ß√£o
        onAuthStateChanged(auth, (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const appContainer = document.getElementById('appContainer');
            
            if (user) {
                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;
                loadingScreen.style.display = 'none';
                appContainer.style.display = 'grid';
                
                // Inicializar app
                window.initializeApp();
            } else {
                window.location.href = 'login-dcont.html';
            }
        });
        
        // Logout
        window.logout = async () => {
            if (confirm('Deseja sair?')) {
                try {
                    await signOut(auth);
                    window.location.href = 'login-dcont.html';
                } catch (error) {
                    alert('Erro ao sair');
                }
            }
        };
        
        // Inicializar app
        window.initializeApp = async () => {
            console.log('App inicializado com Firebase Firestore');
            await loadLeads();
            await loadProjects();
        };
        
        // LEADS - Carregar do Firestore
        window.loadLeads = async () => {
            try {
                showAlert('üîÑ Carregando leads...', 'success');
                
                const leadsRef = collection(db, 'leads');
                const q = query(leadsRef, orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                window.leadsData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    window.leadsData.push({
                        id: doc.id,
                        ...data,
                        data: data.createdAt?.toDate().toLocaleDateString('pt-BR') || 'N/A'
                    });
                });
                
                updateDashboard();
                updateLeadsTable();
                showAlert(`‚úÖ ${window.leadsData.length} leads carregados!`, 'success');
                
            } catch (error) {
                console.error('Erro ao carregar leads:', error);
                showAlert('‚ùå Erro ao carregar leads. Verifique o Firestore.', 'error');
                window.leadsData = [];
                updateDashboard();
                updateLeadsTable();
            }
        };
        
        // LEADS - Atualizar status
        window.updateLeadStatus = async (leadId, newStatus) => {
            try {
                const leadRef = doc(db, 'leads', leadId);
                await updateDoc(leadRef, {
                    status: newStatus,
                    updatedAt: Timestamp.now()
                });
                
                showAlert('‚úÖ Status atualizado!', 'success');
                await loadLeads();
                
            } catch (error) {
                console.error('Erro:', error);
                showAlert('‚ùå Erro ao atualizar status', 'error');
            }
        };
        
        // PROJETOS - Carregar
        window.loadProjects = async () => {
            try {
                const projectsRef = collection(db, 'projects');
                const q = query(projectsRef, orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                window.projectsData = [];
                querySnapshot.forEach((doc) => {
                    window.projectsData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateProjectsTable();
                
            } catch (error) {
                console.error('Erro ao carregar projetos:', error);
                window.projectsData = [];
                updateProjectsTable();
            }
        };
        
        // PROJETOS - Criar
        window.createProject = async () => {
            const clientName = document.getElementById('projectClientName').value;
            const clientCompany = document.getElementById('projectClientCompany').value;
            const service = document.getElementById('projectService').value;
            const value = document.getElementById('projectValue').value;
            
            if (!clientName || !service) {
                alert('Preencha os campos obrigat√≥rios');
                return;
            }
            
            try {
                await addDoc(collection(db, 'projects'), {
                    clientName,
                    clientCompany,
                    service,
                    value: parseFloat(value) || 0,
                    status: 'novo',
                    progress: 0,
                    createdBy: currentUser.email,
                    createdAt: Timestamp.now(),
                    updatedAt: Timestamp.now()
                });
                
                showAlert('‚úÖ Projeto criado!', 'success');
                document.getElementById('projectForm').reset();
                await loadProjects();
                
            } catch (error) {
                console.error('Erro:', error);
                showAlert('‚ùå Erro ao criar projeto', 'error');
            }
        };
        
        // PROJETOS - Atualizar status
        window.updateProjectStatus = async (projectId, newStatus) => {
            try {
                const projectRef = doc(db, 'projects', projectId);
                await updateDoc(projectRef, {
                    status: newStatus,
                    updatedAt: Timestamp.now()
                });
                
                // Adicionar ao hist√≥rico
                await addDoc(collection(db, 'history'), {
                    projectId,
                    type: 'status_change',
                    description: `Status alterado para ${newStatus}`,
                    oldValue: null,
                    newValue: newStatus,
                    createdBy: currentUser.email,
                    createdAt: Timestamp.now()
                });
                
                showAlert('‚úÖ Status atualizado!', 'success');
                await loadProjects();
                
            } catch (error) {
                console.error('Erro:', error);
                showAlert('‚ùå Erro ao atualizar', 'error');
            }
        };
        
        // PROJETOS - Atualizar progresso
        window.updateProjectProgress = async (projectId, progress) => {
            try {
                const projectRef = doc(db, 'projects', projectId);
                await updateDoc(projectRef, {
                    progress: parseInt(progress),
                    updatedAt: Timestamp.now()
                });
                
                await loadProjects();
                
            } catch (error) {
                console.error('Erro:', error);
                showAlert('‚ùå Erro ao atualizar progresso', 'error');
            }
        };
        
        // Exportar para escopo global
        window.db = db;
        window.auth = auth;
        window.currentUser = currentUser;
    </script>
    
    <script>
        // Vari√°veis globais
        window.leadsData = [];
        window.projectsData = [];
        
        // Navega√ß√£o
        function showView(viewName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewName).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Atualizar dashboard
        function updateDashboard() {
            const hoje = new Date().toLocaleDateString('pt-BR');
            document.getElementById('totalLeads').textContent = window.leadsData.length;
            document.getElementById('leadsHoje').textContent = window.leadsData.filter(l => l.data === hoje).length;
            document.getElementById('leadsEmana').textContent = window.leadsData.length;
            
            const tbody = document.getElementById('leadsTable');
            tbody.innerHTML = window.leadsData.slice(0, 5).map(lead => `
                <tr>
                    <td>${lead.data}</td>
                    <td><strong>${lead.nome}</strong></td>
                    <td>${lead.email}</td>
                    <td>${lead.empresa || '-'}</td>
                    <td>${lead.faturamento || '-'}</td>
                    <td><span class="badge badge-new">${lead.status || 'Novo'}</span></td>
                </tr>
            `).join('') || '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üìä</div><p>Nenhum lead</p></td></tr>';
        }
        
        // Atualizar tabela de leads
        function updateLeadsTable() {
            const tbody = document.getElementById('allLeadsTable');
            tbody.innerHTML = window.leadsData.map(lead => `
                <tr>
                    <td>${lead.data}</td>
                    <td><strong>${lead.nome}</strong></td>
                    <td>${lead.email}</td>
                    <td>${lead.telefone}</td>
                    <td>${lead.empresa || '-'}</td>
                    <td>${lead.faturamento || '-'}</td>
                    <td>
                        <select onchange="updateLeadStatus('${lead.id}', this.value)" style="padding: 0.5rem; border-radius: 6px;">
                            <option value="novo" ${lead.status === 'novo' ? 'selected' : ''}>Novo</option>
                            <option value="contatado" ${lead.status === 'contatado' ? 'selected' : ''}>Contatado</option>
                            <option value="qualificado" ${lead.status === 'qualificado' ? 'selected' : ''}>Qualificado</option>
                            <option value="convertido" ${lead.status === 'convertido' ? 'selected' : ''}>Convertido</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="createProposalFromLead('${lead.nome}','${lead.empresa}','${lead.email}','${lead.telefone}')">
                            üìù Proposta
                        </button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">üë•</div><p>Nenhum lead</p></td></tr>';
        }
        
        // Atualizar tabela de projetos
        function updateProjectsTable() {
            const tbody = document.getElementById('projectsTable');
            
            const statusBadges = {
                'novo': 'badge-new',
                'em-andamento': 'badge-contacted',
                'concluido': 'badge-won',
                'pausado': 'badge-lost'
            };
            
            tbody.innerHTML = window.projectsData.map(project => `
                <tr>
                    <td><strong>${project.clientName}</strong></td>
                    <td>${project.clientCompany || '-'}</td>
                    <td>${project.service}</td>
                    <td>
                        <select onchange="updateProjectStatus('${project.id}', this.value)" style="padding: 0.5rem; border-radius: 6px;">
                            <option value="novo" ${project.status === 'novo' ? 'selected' : ''}>Novo</option>
                            <option value="em-andamento" ${project.status === 'em-andamento' ? 'selected' : ''}>Em Andamento</option>
                            <option value="concluido" ${project.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                            <option value="pausado" ${project.status === 'pausado' ? 'selected' : ''}>Pausado</option>
                        </select>
                    </td>
                    <td>
                        <input type="range" min="0" max="100" value="${project.progress || 0}" 
                               onchange="updateProjectProgress('${project.id}', this.value)"
                               style="width: 100px;">
                        <span>${project.progress || 0}%</span>
                    </td>
                    <td>R$ ${(project.value || 0).toLocaleString('pt-BR')}</td>
                </tr>
            `).join('') || '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üìä</div><p>Nenhum projeto</p></td></tr>';
        }
        
        // Outras fun√ß√µes mantidas do portal anterior...
        function createProposalFromLead(nome, empresa, email, telefone) {
            showView('propostas');
            document.getElementById('clientName').value = nome;
            document.getElementById('clientCompany').value = empresa;
            document.getElementById('clientEmail').value = email;
            document.getElementById('clientPhone').value = telefone;
        }
        
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer') || document.querySelector('.content-card');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.prepend(alert);
            setTimeout(() => alert.remove(), 5000);
        }
        
        // Adicione as outras fun√ß√µes do portal anterior aqui...
    </script>
</body>
</html>
